-- 1. USUARIOS (Maestra)
CREATE TABLE USUARIOS (
    ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    USUARIO VARCHAR2(50) UNIQUE NOT NULL,
    PASSWORD VARCHAR2(255) NOT NULL,
    EMAIL VARCHAR2(100) UNIQUE NOT NULL,
    NOMBRE_NEGOCIO VARCHAR2(100),
    PIN_SEGURIDAD VARCHAR2(4) DEFAULT '1234',
    ESTADO NUMBER(1) DEFAULT 1,
    FECHA_REGISTRO TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 2. CATEGORIAS
CREATE TABLE CATEGORIAS (
    ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    USUARIO_ID NUMBER NOT NULL,
    NOMBRE VARCHAR2(50) NOT NULL,
    ACTIVO NUMBER(1) DEFAULT 1,
    CONSTRAINT FK_CAT_USER FOREIGN KEY (USUARIO_ID) REFERENCES USUARIOS(ID) ON DELETE CASCADE
);

-- 3. CLIENTES (Con Teléfono y Dirección obligatorios)
CREATE TABLE CLIENTES (
    ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    USUARIO_ID NUMBER NOT NULL,
    NOMBRE VARCHAR2(100) NOT NULL,
    CEDULA VARCHAR2(20) NOT NULL,
    TELEFONO VARCHAR2(20) NOT NULL,
    EMAIL VARCHAR2(100),
    DIRECCION VARCHAR2(255) NOT NULL,
    DEUDA NUMBER(10, 2) DEFAULT 0,
    ESTADO VARCHAR2(20) DEFAULT 'ACTIVO',
    FECHA_REGISTRO DATE DEFAULT SYSDATE,
    CONSTRAINT FK_CLI_USER FOREIGN KEY (USUARIO_ID) REFERENCES USUARIOS(ID) ON DELETE CASCADE
);

-- 4. PRODUCTOS
CREATE TABLE PRODUCTOS (
    ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    USUARIO_ID NUMBER NOT NULL,
    CATEGORIA_ID NUMBER NOT NULL,
    CODIGO VARCHAR2(50),
    NOMBRE VARCHAR2(100) NOT NULL,
    PRECIO_VENTA NUMBER(10, 2) NOT NULL,
    PRECIO_COSTO NUMBER(10, 2) NOT NULL,
    STOCK NUMBER DEFAULT 0,
    STOCK_MINIMO NUMBER DEFAULT 5,
    ACTIVO NUMBER(1) DEFAULT 1,
    CONSTRAINT FK_PROD_USER FOREIGN KEY (USUARIO_ID) REFERENCES USUARIOS(ID),
    CONSTRAINT FK_PROD_CAT FOREIGN KEY (CATEGORIA_ID) REFERENCES CATEGORIAS(ID)
);

-- 5. PEDIDOS (Unificado: POS y TELEPEDIDO)
CREATE TABLE PEDIDOS (
    ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    USUARIO_ID NUMBER NOT NULL,
    CLIENTE_ID NUMBER NOT NULL,
    TOTAL NUMBER(10, 2) NOT NULL,
    METODO_PAGO VARCHAR2(20), -- 'cash', 'credit', etc.
    AVANCE NUMBER(10, 2) DEFAULT 0,
    ORIGEN VARCHAR2(20),      -- 'POS' o 'TELEPEDIDO'
    ESTADO VARCHAR2(20),      -- 'ENTREGADO', 'PENDIENTE', 'CANCELADO'
    PAGO_ESTADO VARCHAR2(20), -- 'PAGADO', 'PENDIENTE'
    FECHA TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT FK_PED_USER FOREIGN KEY (USUARIO_ID) REFERENCES USUARIOS(ID),
    CONSTRAINT FK_PED_CLI FOREIGN KEY (CLIENTE_ID) REFERENCES CLIENTES(ID)
);

-- 6. PEDIDO_DETALLES
CREATE TABLE PEDIDO_DETALLES (
    ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    PEDIDO_ID NUMBER NOT NULL,
    PRODUCTO_ID NUMBER NOT NULL,
    CANTIDAD NUMBER NOT NULL,
    PRECIO_UNITARIO NUMBER(10, 2) NOT NULL,
    SUBTOTAL NUMBER(10, 2) NOT NULL,
    CONSTRAINT FK_DET_PED FOREIGN KEY (PEDIDO_ID) REFERENCES PEDIDOS(ID) ON DELETE CASCADE,
    CONSTRAINT FK_DET_PROD FOREIGN KEY (PRODUCTO_ID) REFERENCES PRODUCTOS(ID)
);

-- 7. PAGOS (Control de Origen y Deudas)
CREATE TABLE PAGOS (
    ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    USUARIO_ID NUMBER NOT NULL,
    CLIENTE_ID NUMBER NOT NULL,
    MONTO NUMBER(10, 2) NOT NULL,
    REFERENCIA VARCHAR2(100), -- 'efectivo', 'transferencia', etc.
    DEUDA_ANTERIOR NUMBER(10, 2),
    DEUDA_NUEVA NUMBER(10, 2),
    FECHA_PAGO TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT FK_PAGO_USER FOREIGN KEY (USUARIO_ID) REFERENCES USUARIOS(ID),
    CONSTRAINT FK_PAGO_CLI FOREIGN KEY (CLIENTE_ID) REFERENCES CLIENTES(ID)
);

COMMIT;
